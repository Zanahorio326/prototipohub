<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin √ÅGORA</title>
  <style>
    :root { --bg:#f5f5f5; --fg:#333; --panel-bg:#fff; --input-bg:#fff; --border:#ccc; --shadow:rgba(0,0,0,0.1); --btn-save:#2ecc71; --btn-delete:#e74c3c; --transition:0.3s; }
    [data-theme="dark"] { --bg:#121212; --fg:#eee; --panel-bg:#1e1e1e; --input-bg:#2a2a2a; --border:#444; --shadow:rgba(0,0,0,0.5); }
    * { box-sizing:border-box; margin:0; padding:0; transition:var(--transition); }
    body { background:var(--bg); color:var(--fg); font-family:Arial,sans-serif; display:flex; gap:20px; padding:20px; }
    .toggle { position:fixed; top:10px; right:10px; font-size:24px; cursor:pointer; }
    .panel { background:var(--panel-bg); padding:15px; border-radius:6px; box-shadow:0 2px 5px var(--shadow); flex:1; max-width:600px; display:flex; flex-direction:column; gap:10px; }
    h2 { font-size:20px; }
    label { font-weight:bold; margin-top:10px; }
    input,select,textarea { width:100%; padding:8px; margin-top:4px; border:1px solid var(--border); border-radius:4px; background:var(--input-bg); color:var(--fg); font-size:14px; }
    textarea { resize:vertical; }
    .actions { display:flex; justify-content:flex-end; gap:5px; margin-top:15px; }
    button { padding:10px; border:none; border-radius:4px; font-size:14px; cursor:pointer; box-shadow:0 1px 3px var(--shadow); color:#fff; }
    .btn-save { background:var(--btn-save); }
    .btn-delete { background:var(--btn-delete); }
    .task-item { display:flex; justify-content:space-between; align-items:center; padding:8px; border-bottom:1px solid var(--border); }
    .task-item span { flex:1; }
    .task-item button { background:transparent; border:none; cursor:pointer; font-size:16px; color:var(--fg); }
  </style>
</head>
<body>
  <div class="toggle" id="theme-toggle">‚òÄÔ∏è</div>
  <div class="panel">
    <h2 id="form-title">Nueva Tarea</h2>
    <form id="task-form">
      <label for="name">Nombre</label>
      <input type="text" id="name" required>
      <label for="date">Fecha l√≠mite</label>
      <input type="date" id="date" required>
      <label for="state">Estado</label>
      <select id="state" required>
        <option value="">-- Selecciona estado --</option>
        <option value="paused">En pausa</option>
        <option value="convo">En conversaci√≥n</option>
        <option value="estudio">En estudio</option>
        <option value="dev">En desarrollo</option>
        <option value="test">Implementaci√≥n Testing</option>
        <option value="mercado">En el mercado</option>
        <option value="observ">En observaci√≥n</option>
      </select>
      <label for="desc">Descripci√≥n</label>
      <textarea id="desc" rows="3" required></textarea>
      <div class="actions">
        <button type="button" class="btn-delete" id="cancel-btn" style="display:none;">Cancelar</button>
        <button type="submit" class="btn-save" id="save-btn">Guardar</button>
      </div>
    </form>

    <h2>Tareas Existentes</h2>
    <div id="task-list"></div>
  </div>

  <script>
    // Tema persistente
    const toggleBtn = document.getElementById('theme-toggle');
    const root = document.documentElement;
    let dark = localStorage.getItem('admin_theme') === 'dark';
    function applyTheme() {
      if (dark) { root.setAttribute('data-theme','dark'); toggleBtn.textContent='üåô'; }
      else { root.removeAttribute('data-theme'); toggleBtn.textContent='‚òÄÔ∏è'; }
    }
    toggleBtn.onclick = () => { dark = !dark; localStorage.setItem('admin_theme', dark?'dark':'light'); applyTheme(); };
    applyTheme();

    // Config GitHub
    const GITHUB_TOKEN = '<TU_TOKEN_AQUI>';
    const REPO = 'zanahorio326/prototipohub';
    const FILE_PATH = 'tasks.json';
    const BRANCH = 'main';
    const API_URL = `https://api.github.com/repos/${REPO}/contents/${FILE_PATH}`;

    // Gestion de tareas local
    let tasks = [];
    const form = document.getElementById('task-form');
    const listEl = document.getElementById('task-list');
    let editIndex = null;

    async function loadFromGitHub() {
      const res = await fetch(API_URL + `?ref=${BRANCH}`);
      const data = await res.json();
      const content = atob(data.content.replace(/\n/g,''));
      tasks = JSON.parse(content);
      renderList();
      window.sha = data.sha;
    }

    async function saveToGitHub() {
      const content = btoa(JSON.stringify(tasks, null, 2));
      const body = { message: 'Actualiza tareas', content, sha: window.sha, branch: BRANCH };
      await fetch(API_URL, {
        method: 'PUT',
        headers: { Authorization: `token ${GITHUB_TOKEN}`, 'Content-Type':'application/json' },
        body: JSON.stringify(body)
      });
      await loadFromGitHub();
    }

    function renderList() {
      listEl.innerHTML='';
      tasks.forEach((t,i)=>{
        const item=document.createElement('div'); item.className='task-item';
        const name=document.createElement('span');
        name.textContent=`${t.name} (${new Date(t.deadline).toLocaleDateString('es-CL')}, ${getStateText(t.state)})`;
        const editBtn=document.createElement('button'); editBtn.textContent='‚úèÔ∏è'; editBtn.onclick=()=>startEdit(i);
        const delBtn=document.createElement('button'); delBtn.textContent='üóëÔ∏è'; delBtn.className='btn-delete'; delBtn.onclick=()=>deleteTask(i);
        item.append(name,editBtn,delBtn);
        listEl.appendChild(item);
      });
    }

    function startEdit(i) {
      editIndex=i;
      const t=tasks[i];
      document.getElementById('form-title').textContent='Editar Tarea';
      form.name.value=t.name; form.date.value=t.deadline.slice(0,10);
      form.state.value=t.state; form.desc.value=t.desc;
      document.getElementById('save-btn').textContent='Actualizar';
      document.getElementById('cancel-btn').style.display='inline-block';
    }
    function cancelEdit(){ editIndex=null; form.reset(); document.getElementById('form-title').textContent='Nueva Tarea'; document.getElementById('save-btn').textContent='Guardar'; document.getElementById('cancel-btn').style.display='none'; }
    function getStateText(s){ return {paused:'En pausa',convo:'En conversaci√≥n',estudio:'En estudio',dev:'En desarrollo',test:'Testing',mercado:'En el mercado',observ:'En observaci√≥n'}[s]||''; }

    form.onsubmit = async e => {
      e.preventDefault();
      const name=form.name.value.trim(); const date=form.date.value; const state=form.state.value; const desc=form.desc.value.trim();
      if(!name||!date||!state||!desc){ alert('Completa todos los campos.'); return; }
      const t={ name, deadline: date+'T23:59:59', state, desc };
      if(editIndex===null) tasks.push(t); else tasks[editIndex]=t;
      cancelEdit(); renderList(); await saveToGitHub();
    };
    document.getElementById('cancel-btn').onclick = cancelEdit;

    async function deleteTask(i) {
      if(confirm('¬øEliminar esta tarea?')){
        tasks.splice(i,1);
        renderList();
        await saveToGitHub();
      }
    }

    // Inicializa
    loadFromGitHub();
  </script>
</body>
</html>