<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Editor Restaurado</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #f8f8f8; height: 100vh; overflow: hidden; position: relative; font-family: sans-serif; }
    /* Mesa (lienzo) ocupa casi toda la pantalla con margen blanco */
    #canvas {
      position: absolute;
      top: 20px;
      left: 20px;
      right: 20px;
      bottom: 20px;
      background: white;
      border: 2px dashed #ccc;
      overflow: auto;
    }
    /* Botón puerta flotante */
    #door {
      position: absolute;
      top: 40px;
      left: 40px;
      width: 40px;
      height: 40px;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fff;
      border: 1px solid #aaa;
      border-radius: 4px;
      cursor: grab;
      user-select: none;
      z-index: 10;
    }
    /* Panel deslizante */
    #panel {
      position: absolute;
      top: 0;
      height: 100%;
      width: 0;
      overflow: hidden;
      transition: width 0.3s ease;
      z-index: 5;
      display: none; /* oculto inicialmente */
      align-items: center;
      padding-left: 10px;
      background: transparent;
    }
    /* Botón interno de la herramienta */
    #modBtn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #007bff;
      color: white;
      border: 2px solid #0056b3;
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 16px;
      line-height: 1.2;
      cursor: pointer;
      transition: background 0.2s ease, border-color 0.2s ease;
    }
    #modBtn:hover {
      background: #0056b3;
      border-color: #003f7f;
    }
  </style>
</head>
<body>
  <div id="canvas"></div>
  <div id="panel"></div>
  <!-- Icono de puerta cambia: cerrado 📕, abierto 📖 -->
  <div id="door">📕</div>

  <script>
    (function(){
      const door = document.getElementById('door');
      const panel = document.getElementById('panel');
      const canvas = document.getElementById('canvas');
      let isOpen = false;
      let dragging = false;
      let offsetX = 0, offsetY = 0;

      // Calcular color contrastante
      function invertColor(color) {
        const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(color);
        if (!m) return '#000';
        const r = (255 - parseInt(m[1], 16)).toString(16).padStart(2, '0');
        const g = (255 - parseInt(m[2], 16)).toString(16).padStart(2, '0');
        const b = (255 - parseInt(m[3], 16)).toString(16).padStart(2, '0');
        return `#${r}${g}${b}`;
      }
      function computePanelBg() {
        const behind = window.getComputedStyle(canvas).backgroundColor;
        const rgb = behind.match(/\d+/g);
        if (!rgb) return '#000';
        const hex = '#' + rgb.slice(0,3).map(x=>parseInt(x).toString(16).padStart(2,'0')).join('');
        return invertColor(hex);
      }

      function closePanel() {
        isOpen = false;
        panel.style.width = '0';
        panel.style.background = 'transparent';
        // Esperar a terminar animación antes de ocultar contenido e icono
        panel.addEventListener('transitionend', function handler() {
          panel.style.display = 'none';
          panel.innerHTML = '';
          door.textContent = '📕'; // icono cerrado tras cierre
          panel.removeEventListener('transitionend', handler);
        });
      }

      // Toggle panel on click
      door.addEventListener('click', () => {
        if (dragging) return;
        const doorRect = door.getBoundingClientRect();
        if (isOpen) {
          closePanel();
        } else {
          // Abrir panel hacia el lado con más espacio
          const middle = window.innerWidth / 2;
          let panelLeft, panelWidth;
          if (doorRect.left > middle) {
            // Abrir hacia la izquierda
            panelLeft = 0;
            panelWidth = doorRect.left;
          } else {
            // Abrir hacia la derecha
            panelLeft = doorRect.right;
            panelWidth = window.innerWidth - doorRect.right;
          }
          panel.style.display = 'flex';
          panel.style.top = doorRect.top + 'px';
          panel.style.left = panelLeft + 'px';
          panel.style.height = doorRect.height + 'px';
          panel.style.width = panelWidth + 'px';
          panel.style.background = computePanelBg();
          panel.innerHTML = '<button id="modBtn">🔘<br>Botón</button>';
          const script = document.createElement('script');
          script.src = 'https://zanahorio326.github.io/prototipohub/moduloboton.js';
          panel.appendChild(script);
          door.textContent = '📖'; // icono abierto
          isOpen = true;
        }
      });
      
      // Ensure single click or pointerup closes panel immediately
      door.addEventListener('pointerup', () => {
        if (isOpen) closePanel();
      });

      function startDrag(x, y) {
        if (isOpen) closePanel();
        dragging = true;
        offsetX = x - door.offsetLeft;
        offsetY = y - door.offsetTop;
        door.style.cursor = 'grabbing';
      }
      function duringDrag(x, y) {
        if (!dragging) return;
        let nx = x - offsetX;
        let ny = y - offsetY;
        nx = Math.max(0, Math.min(nx, window.innerWidth - door.offsetWidth));
        ny = Math.max(0, Math.min(ny, window.innerHeight - door.offsetHeight));
        door.style.left = nx + 'px';
        door.style.top = ny + 'px';
      }
      function endDrag() {
        if (dragging) {
          dragging = false;
          door.style.cursor = 'grab';
        }
      }

      // Mouse events
      door.addEventListener('mousedown', e => startDrag(e.clientX, e.clientY));
      document.addEventListener('mousemove', e => duringDrag(e.clientX, e.clientY));
      document.addEventListener('mouseup', endDrag);

      // Touch events
      door.addEventListener('touchstart', e => {
        const t = e.touches[0];
        startDrag(t.clientX, t.clientY);
      });
      document.addEventListener('touchmove', e => {
        const t = e.touches[0];
        duringDrag(t.clientX, t.clientY);
        e.preventDefault();
      }, { passive: false });
      document.addEventListener('touchend', endDrag);
    })();
  </script>
</body>
</html>